function startTelegramSiteHelper(e){console.log("Starting Telegram Site Helper 2.0");try{serverSideEvent.close()}catch(e){}try{longPoll.abort()}catch(e){}try{clearTimeout(longPollTimer)}catch(e){}if(!e.apiUrl)return console.error("TSH > Bad API URL.."),!1;if("popup"!=e.type&&"embed"!=e.type&&(e.type="popup"),"embed"==e.type){if(!e.parentElementId)return console.error("TSH > Parent Element Id is not defined! It is required in embed chat mode!"),!1}else{var t=e.chatPosition;"lt"!=t&&"lb"!=t&&"rt"!=t&&"rb"!=t&&"tl"!=t&&"tr"!=t&&"bl"!=t&&"br"!=t&&(e.chatPosition="br")}if(e.type&&""!=e.type||(e.type="lp"),e.label&&""!=e.label||(e.label="Ask your question here!"),e.yourName&&""!=e.yourName||(e.yourName="Ask your question here!"),e.yourPhone&&""!=e.yourPhone||(e.yourPhone="Ask your question here!"),e.startChat&&""!=e.startChat||(e.startChat="Ask your question here!"),e.enterYourMessage&&""!=e.enterYourMessage||(e.enterYourMessage="Ask your question here!"),e.you&&""!=e.you||(e.you="You"),e.attachFileTitle&&""!=e.attachFileTitle||(e.attachFileTitle="Attach the file"),e.maxFileSize&&""!=e.maxFileSize||(e.maxFileSize=2048),e.maxFileSizeError&&""!=e.maxFileSizeError||(e.maxFileSizeError="Error: max file size is: "),e.manager&&""!=e.manager||(e.manager="Manager"),e.mainColor&&""!=e.mainColor||(e.mainColor="#E8E8E8"),e.accentColor&&""!=e.accentColor||(e.accentColor="#179CDE"),e.textColor&&""!=e.textColor||(e.textColor="#000"),e.fontFamily&&""!=e.fontFamily||(e.fontFamily="arial"),e.boxWidth&&""!=e.boxWidth||("embed"==e.type?e.boxWidth="100%":e.boxWidth="350px"),e.boxHeight&&""!=e.boxHeight||("embed"==e.type?e.boxHeight="100%":e.boxHeight="290px"),e.boxZindex&&""!=e.boxZindex||(e.boxZindex="9999"),e.base64string&&(e.sound=new Audio(e.base64string)),"popup"==e.type&&1==e.showLabel){if("lb"==e.chatPosition||"rt"==e.chatPosition)var a="tsh-label tsh-rotate270 tsh-label-"+e.chatPosition;else if("lt"==e.chatPosition||"rb"==e.chatPosition)a="tsh-label tsh-rotate90 tsh-label-"+e.chatPosition;else a="tsh-label tsh-label-"+e.chatPosition;var l="font-family:"+e.fontFamily+"; background-color:"+e.accentColor+"; z-index:"+e.boxZindex,o=document.createElement("div");o.id="telegramSiteHelperChatLabel",o.setAttribute("class",a),o.setAttribute("style",l),o.innerHTML=e.label,console.log(o),document.body.appendChild(o)}var r="background-color:"+e.mainColor+"; color:"+e.textColor+"; font-family:"+e.fontFamily+"; width:"+e.boxWidth+";height:"+e.boxHeight+";z-index:"+e.boxZindex+";";if("popup"==e.type){var n="tsh-chatbox tsh-chatbox-"+e.chatPosition;"lt"==t||"lb"==t?n+=" slideInLeft":"rt"==t||"rb"==t?n+=" slideInRight":"tl"==t||"tr"==t?n+=" slideInDown":"bl"!=t&&"br"!=t||(n+=" slideInUp"),r+="display:none; position:fixed;"}else{n="tsh-chatbox";r+="display:block; position:relative;"}var s=document.createElement("div");s.id="telegramSiteHelperChatBox",s.setAttribute("class",n+"  animated"),s.setAttribute("style",r);var i='<div id="telegramSiteHelperChatBox-header" class="tsh-chatbox-header" style="background-color:'+e.accentColor+';">';if(i+=e.label,"popup"==e.type&&(i+='<div id="telegramSiteHelperChatBox-close" class="tsh-chatbox-close">&times;</div>'),i+="</div>",i+='<div id="telegramSiteHelperChatBox-greeting" class="tsh-chatbox-greeting">',e.requireName){if(null!=e.overrideChatCustomerName&&""!=e.overrideChatCustomerName)var c=e.overrideChatCustomerName,m="disabled";else c="",m="";i+='<input type="text" '+m+' value="'+c+'" id="chatCustomerName" class="tsh-chatbox-greeting-input" placeholder="'+e.yourName+'">'}if(e.requirePhone&&(i+='<input type="text" id="chatCustomerPhone" class="tsh-chatbox-greeting-input" placeholder="'+e.yourPhone+'">'),i+='<button id="telegramSiteHelperStartChat" class="tsh-chatbox-greeting-button" style="background-color:'+e.accentColor+'">'+e.startChat+"</button>",i+="</div>",i+='<div id="telegramSiteHelperChatBox-container" class="tsh-chatbox-container"></div>',i+='<div id="telegramSiteHelperChatBox-input" class="tsh-chatbox-inputArea">',e.attachFile)var d="left:30px;";else d="left:0px;";if(i+='<div class="tsh-chatbox-message-container" id="telegramSiteHelperMessageContainer" style="'+d+'">',i+='<textarea id="telegramSiteHelperMessage" class="tsh-chatbox-message" placeholder="'+e.enterYourMessage+'"></textarea>',i+="</div>",e.attachFile&&(i+='<div id="telegramSiteHelperAttach" class="tsh-chatbox-attach" title="'+e.attachFileTitle+'"></div>',i+='<input type="file" id="telegramSiteHelperAttachInput">'),i+='<div id="telegramSiteHelperEnter" class="tsh-chatbox-enter"></div>',i+="</div>","embed"==e.type){if(e.parentElementId){var g=document.getElementById(e.parentElementId);g?g.appendChild(s):console.error("TSH > Unknown parentElementId for chat box")}}else document.body.appendChild(s);if(document.getElementById("telegramSiteHelperChatBox").innerHTML=i,e.attachFile){var h=document.createElement("div");h.id="tsh-photo-show",document.body.appendChild(h),document.getElementById("tsh-photo-show").onclick=function(){document.getElementById("tsh-photo-show").style.display="none",document.getElementById("tsh-big-image").remove()},bindAttachFile()}"popup"==e.type&&(null==e.popupbyelement||""==e.popupbyelement?(document.getElementById("telegramSiteHelperChatLabel").onclick=function(){document.getElementById("telegramSiteHelperChatBox").style.display="block",document.getElementById("telegramSiteHelperChatLabel").style.display="none",tshScrollDown()},document.getElementById("telegramSiteHelperChatBox-close").onclick=function(){document.getElementById("telegramSiteHelperChatLabel").style.display="block",document.getElementById("telegramSiteHelperChatBox").style.display="none"}):(document.getElementById(e.popupbyelement).onclick=function(){document.getElementById("telegramSiteHelperChatBox").style.display="block",tshScrollDown()},document.getElementById("telegramSiteHelperChatBox-close").onclick=function(){document.getElementById("telegramSiteHelperChatBox").style.display="none"})),document.getElementById("telegramSiteHelperEnter").onclick=function(){sendMessage()},document.getElementById("telegramSiteHelperMessage").onkeypress=function(e){!e.ctrlKey&&!e.metaKey||13!=e.keyCode&&10!=e.keyCode?13!=e.keyCode&&10!=e.keyCode||sendMessage():document.getElementById("telegramSiteHelperMessage").value+="\r"};var p=telegramSiteHelperGetCookie("chatId");e.chatId=p,e.chatId?"sse"==e.translationType?startTranslation():startLongPoll():0==e.requireName&&0==e.requirePhone&&"embed"==e.type?newChat():document.getElementById("telegramSiteHelperStartChat").onclick=function(){newChat()}}function startTranslation(){console.log("TSH > Start getting data by ServerSideEvent"),document.getElementById("telegramSiteHelperChatBox-greeting").style.display="none",document.getElementById("telegramSiteHelperChatBox-container").style.display="block",document.getElementById("telegramSiteHelperChatBox-input").style.display="block",tshScrollDown();try{serverSideEvent.close()}catch(e){}serverSideEvent=new EventSource(telegramSiteHelper.apiUrl+"?act=pollMessages&type=sse&chatId="+telegramSiteHelper.chatId),serverSideEvent.onmessage=function(e){var t=JSON.parse(e.data);if("allMessages"==t.command)addMessages(t.messages);else if("newMessages"==t.command)addMessages(t.messages),telegramSiteHelper.sound&&telegramSiteHelper.sound.play();else if("loadComplete"==t.command);else if("error"==t.command&&"BAD_CHAT_ID"==t.error)try{serverSideEvent.close(),newChat()}catch(e){}}}function startLongPoll(){console.log("TSH > Start getting data by LongPoll"),document.getElementById("telegramSiteHelperChatBox-greeting").style.display="none",document.getElementById("telegramSiteHelperChatBox-container").style.display="block",document.getElementById("telegramSiteHelperChatBox-input").style.display="block";try{longPoll.abort()}catch(e){}try{clearTimeout(longPollTimer)}catch(e){}longPoll=new XMLHttpRequest,longPoll.timeout=6e4;var e=telegramSiteHelper.apiUrl+"?act=pollMessages&type=lp&chatId="+telegramSiteHelper.chatId+"&lastMessageId="+lastMessageId;longPoll.open("POST",e,!0),longPoll.send(),longPoll.onreadystatechange=function(){if(4==this.readyState)if(console.log(this.status),200==this.status)if(this.responseText)try{var e=JSON.parse(this.responseText);if("allMessages"==e.command)addMessages(e.messages),lastMessageId=e.lastMessageId,0==lastMessageId?longPollTimer=setTimeout((function(){startLongPoll()}),2e3):startLongPoll();else if("newMessages"==e.command)addMessages(e.messages),telegramSiteHelper.sound&&telegramSiteHelper.sound.play(),lastMessageId=e.lastMessageId,0==lastMessageId?longPollTimer=setTimeout((function(){startLongPoll()}),2e3):startLongPoll();else if("timeout"==e.command)startLongPoll();else if("error"==e.command)if("BAD_CHAT_ID"==e.error)try{longPoll.abort(),clearTimeout(longPollTimer),newChat()}catch(e){}else console.error("TSH > "+e.error),longPollTimer=setTimeout((function(){startLongPoll()}),2e3)}catch(e){console.log(this.responseText),longPollTimer=setTimeout((function(){startLongPoll()}),2e3)}else console.log(this.responseText),longPollTimer=setTimeout((function(){startLongPoll()}),2e3);else console.log(this),longPollTimer=setTimeout((function(){startLongPoll()}),2e3)}}function newChat(){console.log("TSH > Starting new chat");try{serverSideEvent.close()}catch(e){}try{longPoll.abort()}catch(e){}try{clearTimeout(longPollTimer)}catch(e){}var e=new XMLHttpRequest;e.open("POST",telegramSiteHelper.apiUrl+"?act=newChat",!0);var t=new FormData;if(telegramSiteHelper.requireName||null!=telegramSiteHelper.overrideChatCustomerName){if(null!=telegramSiteHelper.overrideChatCustomerName&&""!=telegramSiteHelper.overrideChatCustomerName)var a=telegramSiteHelper.overrideChatCustomerName;else a=document.getElementById("chatCustomerName").value;t.append("chatCustomerName",a)}telegramSiteHelper.requirePhone&&t.append("chatCustomerPhone",document.getElementById("chatCustomerPhone").value),e.send(t),e.onreadystatechange=function(){if(4==this.readyState)if(200==this.status)if(this.responseText)try{var e=JSON.parse(this.responseText);"ok"==e.status?(telegramSiteHelper.chatId=e.chatId,telegramSiteHelper.manager=e.manager,telegramSiteHelperSetCookie("chatId",telegramSiteHelper.chatId,{expires:36e4,path:"/"}),"sse"==telegramSiteHelper.translationType?startTranslation():startLongPoll()):(document.getElementById("telegramSiteHelperChatBox-greeting").style.display="none",document.getElementById("telegramSiteHelperChatBox-container").style.display="block","NO_MANAGERS_AVALIABLE"==e.error?addSystemMessage(telegramSiteHelper.noManagersAvailable,"tsh-danger"):addSystemMessage(e.error,"tsh-danger"))}catch(e){console.error("TSH > Can`t create new chat"),console.log(this.responseText)}else console.error("TSH > Can`t create new chat"),console.log(this.responseText);else console.error("TSH > Can`t create new chat"),console.log(this)}}function addMessages(e){e.forEach((function(e,t){addMessage(e)}))}function addMessage(e){try{document.getElementById("tsh_"+e.msgId).remove()}catch(e){}var t="";if("client"==e.msgFrom)var a="tsh-right",l=telegramSiteHelper.you;else{a="";if(null!=e.managerName)l=e.managerName;else l=telegramSiteHelper.manager}t+='<div class="tsh-msg '+a+'" id="tsh_'+e.msgId+'">',t+='<div class="tsh-msg-header">'+l+' <span class="tsh-time">'+e.msgTime+"<span></div>",null==e.msgText&&(e.msgText="");try{var o=JSON.parse(e.msgText);if(o.file&&o.filename)e.msgText='<a href="'+telegramSiteHelper.apiUrl+"?act=getDocument&fileId="+o.file+"&filename="+encodeURIComponent(o.filename)+'" target="_blank" class="tsh-file" id="file_'+e.msgId+'">'+o.filename+"</a>";else if(o.photo)e.msgText="<div onclick=\"bigImg('img_"+e.msgId+'\')" class="tsh-img" id="image_'+e.msgId+'"><img  id="img_'+e.msgId+'" src="'+telegramSiteHelper.apiUrl+"?act=getPhoto&fileId="+o.photo+'"></div>';else if(o.text){var r=new RegExp("(?:(?:ht|f)tps?://)?(?:[\\-\\w]+:[\\-\\w]+@)?(?:[0-9a-z][\\-0-9a-z]*[0-9a-z]\\.)+[a-z]{2,6}(?::\\d{1,5})?(?:[?/\\\\#][?!^$.(){}:|=[\\]+\\-/\\\\*;&~#@,%\\wА-Яа-я]*)?");e.msgText=o.text.replace(r,(function(e){var t=null===/:\/\//.exec(e)?"http://"+e:e;return'<a target="_blank" href="'+t+'">'+t+"</a>"}))}}catch(e){}t+='<div class="tsh-msg-body">'+e.msgText+"</div>",t+="</div>",document.getElementById("telegramSiteHelperChatBox-container").innerHTML+=t,setTimeout((function(){tshScrollDown()}),100)}function addSystemMessage(e,t){var a="";a+='<div class="tsh-msg tsh-system '+t+'">',a+='<div class="tsh-msg-header"></div>',a+='<div class="tsh-msg-body">'+e+"</div>",a+="</div>",document.getElementById("telegramSiteHelperChatBox-container").innerHTML+=a,tshScrollDown()}function sendMessage(){var e=document.getElementById("telegramSiteHelperMessage").value;if(null!=e&&""!=e){var t=new XMLHttpRequest;t.open("POST",telegramSiteHelper.apiUrl+"?act=sendMessage",!0);var a=new FormData;a.append("message",e),a.append("chatId",telegramSiteHelper.chatId),t.send(a),setTimeout((function(){document.getElementById("telegramSiteHelperMessage").value=""}),20),t.onreadystatechange=function(){if(4==this.readyState)if(200==this.status)if(this.responseText)try{var e=JSON.parse(this.responseText);"ok"==e.status||(console.error("Can`t send message..."),console.log(e.error),"NO_MANAGER"==e.error&&(addSystemMessage("Error: no manager","danger"),newChat()))}catch(e){console.error("Can`t send message..."),console.log(this.responseText)}else console.error("Can`t send message..."),console.log(this.responseText);else console.error("Can`t send message..."),console.log(this)}}}function bindAttachFile(){document.getElementById("telegramSiteHelperAttach").onclick=function(){document.getElementById("telegramSiteHelperAttachInput").click()},document.getElementById("telegramSiteHelperAttachInput").onchange=function(e){var t=e.target.files[0];if(t.size>1e3*telegramSiteHelper.maxFileSize)return addSystemMessage("Error: Max file size is "+telegramSiteHelper.maxFileSize+" kb","tsh-danger"),!1;var a=new FileReader;a.onload=function(e){var a=new XMLHttpRequest;a.open("POST",telegramSiteHelper.apiUrl+"?act=sendMessage",!0);var l=new FormData;l.append("file",e.target.result),l.append("filename",t.name),l.append("chatId",telegramSiteHelper.chatId),a.send(l),document.getElementById("telegramSiteHelperAttachInput").value="",a.onreadystatechange=function(){if(4==this.readyState)if(200==this.status)if(this.responseText)try{var e=JSON.parse(this.responseText);"ok"==e.status||(console.error("Can`t send message..."),console.log(e.error))}catch(e){console.error("Can`t send message..."),console.log(this.responseText)}else console.error("Can`t send message..."),console.log(this.responseText);else console.error("Can`t send message..."),console.log(this)}},a.readAsDataURL(t)}}function bigImg(e){el=document.getElementById(e).cloneNode(!0),newEl=document.getElementById("tsh-photo-show").appendChild(el),newEl.id="tsh-big-image",document.getElementById("tsh-photo-show").style.display="block"}function tshScrollDown(){var e=document.getElementById("telegramSiteHelperChatBox-container").scrollHeight;document.getElementById("telegramSiteHelperChatBox-container").scrollTop=e+200}function telegramSiteHelperGetCookie(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):void 0}function telegramSiteHelperSetCookie(e,t,a){var l=(a=a||{}).expires;if("number"==typeof l&&l){var o=new Date;o.setTime(o.getTime()+1e3*l),l=a.expires=o}l&&l.toUTCString&&(a.expires=l.toUTCString());var r=e+"="+(t=encodeURIComponent(t));for(var n in a){r+="; "+n;var s=a[n];!0!==s&&(r+="="+s)}document.cookie=r}serverSideEvent=null,lastMessageId=0,longPoll=null,longPollTimer=null;